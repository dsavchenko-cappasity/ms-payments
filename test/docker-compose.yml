redis_1:
  image: makeomatic/alpine-redis
  container_name: redis_1
  hostname: redis_1
  expose:
    - "6379"
    - "16379"

redis_2:
  expose:
    - "6379"
    - "16379"
  container_name: redis_2
  hostname: redis_2
  image: makeomatic/alpine-redis

redis_3:
  expose:
    - "6379"
    - "16379"
  container_name: redis_3
  image: makeomatic/alpine-redis
  hostname: redis_3

rabbitmq:
  expose:
    - "4369"
    - "5672"
    - "15672"
    - "25672"
  image: rabbitmq
  container_name: rabbitmq
  hostname: rabbitmq

redis_client:
  links:
    - redis_1
    - redis_2
    - redis_3
  container_name: redis_client
  hostname: redis_client
  image: makeomatic/redis-trib

ms-users:
  links:
    - redis_1
    - redis_2
    - redis_3
    - rabbitmq
    - redis_client
  image: makeomatic/ms-users:5.4.0-1.2.1
  hostname: ms-users
  container_name: ms-users
  volumes:
    - ${PWD}/test/configs:/src/configs:ro
    - ${PWD}/../ms-users:/src/ms-users:ro
  environment:
    NODE_ENV: 'production'
    NCONF_FILE_PATH: '["/src/configs/amqp.js","/src/configs/redis.js","/src/configs/users.js"]'
    MS_USERS__LOGGER: 'true'
    NPM_TOKEN: "random token"

tester:
  image: ${IMAGE}
  links:
    - redis_1
    - redis_2
    - redis_3
    - rabbitmq
    - ms-users
  working_dir: /src
  volumes:
    - ${PWD}:/src
  environment:
    NODE_ENV: "docker"
    DEBUG: ${DEBUG}
    BLUEBIRD_DEBUG: ${B_DEBUG}
    BABEL_CACHE_PATH: "/src/.babel-cache"
  command: "true"
